---
title: 'FC'
author: 'ABO'
date: 'created : 2025-11-04 ‚Äî compiled : `r format(Sys.time(), "%Y-%m-%d %H:%M")`'
output:
  html_document:
    code_folding: hide
    toc: true # Table des mati√®res
    # toc_float: 
      # collapsed: false # Commencer avec le TOC d√©pli√©
      # smooth_scroll: true # Permet un d√©filement fluide jusqu'√† la section s√©lectionn√©e
    # toc_depth: 3 # Profondeur du TOC (niveaux de titres inclus)
    number_sections: true # Num√©rotation des sections
    css: style.css # Fichier CSS personnalis√©
    # df_print: paged # Mode d'affichage des data frames (options : default, paged, kable, tibble, none)
  pdf_document:
    toc: true # Table des mati√®res
    toc_depth: 3 # Profondeur du TOC
    # number_sections: true # Num√©rotation des sections
    # latex_engine: xelatex # Moteur LaTeX (pdflatex, xelatex, lualatex)
    citation_package: natbib # Syst√®me de gestion des citations (natbib, biblatex)
header-includes:
  # - \usepackage{lipsum} # Inclure des packages LaTeX suppl√©mentaires ici
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# CORE
library(tidyverse)
library(janitor)
library(readxl)
library(lubridate)
# FOR REPORT
library(broom)
library(plotly)
library(patchwork)
library(kableExtra)
library(randomcoloR)
library(xml2)
```

```{r FUNCTIONS}
# extract_variant_info <- function(xml_file_path) {
#   cat(xml_file_path, file=stderr())
  
#   # Charger le fichier XML
#   xml_file <- read_xml(xml_file_path)
  
#   # Obtenir le noeud racine
#   root_node <- xml_root(xml_file)
  
#   # Trouver tous les noeuds 'variant'
#   variant_nodes <- xml_find_all(root_node, ".//variant")
  
#   # Extraire le nom du fichier XML sans son chemin complet
#   xml_file_name <- basename(xml_file_path)
  
#   # Mapper sur chaque 'variant' pour extraire les informations
#   variants_data <- map_df(variant_nodes, function(variant) {
    
#     # Extraire les noeuds 'refseq'
#     refseq_nodes <- xml_find_all(variant, ".//refseq")
    
#     # Mapper sur chaque 'refseq' pour obtenir les d√©tails
#     map_df(refseq_nodes, function(refseq) {
#       tibble(
#         chromosome = xml_text(xml_find_first(variant, ".//chromosome")),
#         position = xml_text(xml_find_first(variant, ".//position")),
#         reference = xml_text(xml_find_first(variant, ".//reference")),
#         alternative = xml_text(xml_find_first(variant, ".//alternative")),
#         gene = xml_text(xml_find_first(refseq, ".//gene")),
#         exon = xml_text(xml_find_first(refseq, ".//exon")),
#         function_type = xml_text(xml_find_first(refseq, ".//function")),
#         transcript = xml_text(xml_find_first(refseq, ".//transcript")),
#         nucleotidic_position = xml_text(xml_find_first(refseq, ".//nucleotidic_position")),
#         proteinic_position = xml_text(xml_find_first(refseq, ".//proteinic_position")),
#         prefered_transcript = xml_text(xml_find_first(refseq, ".//prefered_transcript")),
#         xml_file_name = xml_file_name  # Ajouter le nom du fichier XML
#       )
#     })
#   })


#   variants_data <- variants_data # %>% filter(prefered_transcript == "YES")
  
#   return(variants_data)
# }

extract_variant_info <- function(xml_file_path) {
  cat(xml_file_path, file = stderr())

  xml_file  <- read_xml(xml_file_path)
  root_node <- xml_root(xml_file)

  # Infos globales (niveau rapport)
  main_sample_name <- xml_text(xml_find_first(root_node, ".//main_sample_name"))

  # Lib : au niveau pipelines_def/pipeline_def (si plusieurs, on les concat√®ne)
  lib <- xml_find_all(root_node, ".//pipelines_def/pipeline_def/lib") |>
    xml_text() |>
    unique() |>
    paste(collapse = ";")

  variant_nodes <- xml_find_all(root_node, ".//variants/variant")
  xml_file_name <- basename(xml_file_path)

  variants_data <- purrr::map_df(variant_nodes, function(variant) {

    refseq_nodes <- xml_find_all(variant, ".//refseqs/refseq")

    purrr::map_df(refseq_nodes, function(refseq) {
      tibble::tibble(
        main_sample_name = main_sample_name,
        lib = lib,
        chromosome = xml_text(xml_find_first(variant, "./chromosome")),
        position = xml_text(xml_find_first(variant, "./position")),
        reference = xml_text(xml_find_first(variant, "./reference")),
        alternative = xml_text(xml_find_first(variant, "./alternative")),
        gene = xml_text(xml_find_first(refseq, "./gene")),
        exon = xml_text(xml_find_first(refseq, "./exon")),
        function_type = xml_text(xml_find_first(refseq, "./function")),
        transcript = xml_text(xml_find_first(refseq, "./transcript")),
        nucleotidic_position = xml_text(xml_find_first(refseq, "./nucleotidic_position")),
        proteinic_position = xml_text(xml_find_first(refseq, "./proteinic_position")),
        prefered_transcript = xml_text(xml_find_first(refseq, "./prefered_transcript")),
        xml_file_name = xml_file_name
      )
    })
  })

  variants_data
}

extract_variant_info <- function(xml_file_path) {
  cat(xml_file_path, file = stderr())

  xml_file  <- xml2::read_xml(xml_file_path)
  root_node <- xml2::xml_root(xml_file)

  # Helpers s√ªrs
  xtext1 <- function(node, path) {
    n <- xml2::xml_find_first(node, path)
    if (inherits(n, "xml_missing") || length(n) == 0) NA_character_ else xml2::xml_text(n)
  }

  xtext_all_unique <- function(node, path) {
    v <- xml2::xml_find_all(node, path) |>
      xml2::xml_text() |>
      unique()
    if (length(v) == 0) NA_character_ else paste(v, collapse = ";")
  }

  # Infos globales
  main_sample_name <- xtext1(root_node, ".//main_sample_name")
  patient_name     <- xtext1(root_node, ".//patient_name")

  # Infos pipeline
  lib         <- xtext_all_unique(root_node, ".//pipelines_def/pipeline_def/lib")
  barcode     <- xtext_all_unique(root_node, ".//pipelines_def/pipeline_def/barcode")
  sample_name <- xtext_all_unique(root_node, ".//pipelines_def/pipeline_def/sample_name")
  design      <- xtext_all_unique(root_node, ".//pipelines_def/pipeline_def/design")

  xml_file_name <- basename(xml_file_path)
  variant_nodes <- xml2::xml_find_all(root_node, ".//variants/variant")

  variants_data <- purrr::map_df(variant_nodes, function(variant) {

    # ===== VAR_FREQ : moyenne des pipelines =====
    var_freq <- {
      vf <- xml2::xml_find_all(
        variant,
        "./pipelines_var_val/pipeline_var_val/var_freq"
      ) |> xml2::xml_text()

      vf_num <- as.numeric(gsub("%", "", vf))
      if (length(vf_num) == 0) NA_real_ else mean(vf_num, na.rm = TRUE)
    }

    # Champs variant
    chromosome  <- xtext1(variant, "./chromosome")
    position    <- xtext1(variant, "(./position | ./posiition)[1]")
    reference   <- xtext1(variant, "./reference")
    alternative <- xtext1(variant, "./alternative")

    refseq_nodes <- xml2::xml_find_all(variant, "./refseqs/refseq")

    purrr::map_df(refseq_nodes, function(refseq) {
      tibble::tibble(
        main_sample_name = main_sample_name,
        patient_name     = patient_name,
        lib              = lib,
        barcode          = barcode,
        sample_name      = sample_name,
        design           = design,

        chromosome  = chromosome,
        position    = position,
        reference   = reference,
        alternative = alternative,
        var_freq    = var_freq,

        gene                 = xtext1(refseq, "./gene"),
        exon                 = xtext1(refseq, "./exon"),
        function_type        = xtext1(refseq, "./function"),
        transcript           = xtext1(refseq, "./transcript"),
        nucleotidic_position = xtext1(refseq, "./nucleotidic_position"),
        proteinic_position   = xtext1(refseq, "./proteinic_position"),
        prefered_transcript  = xtext1(refseq, "./prefered_transcript"),

        xml_file_name = xml_file_name
      )
    })
  })

  variants_data
}


# Fonction pour obtenir la liste des fichiers XML dans un dossier
get_xml_files <- function(folder_path) {
  list.files(path = folder_path, pattern = "\\.xml$", full.names = TRUE)
}

# Appliquer la fonction extract_variant_info √† tous les fichiers XML dans le dossier
process_xml_folder <- function(folder_path) {
  xml_files <- get_xml_files(folder_path)
  
  # Utiliser map_df pour appliquer la fonction √† chaque fichier et combiner les r√©sultats en un seul DataFrame
  all_variants_data <- map_df(xml_files, extract_variant_info)
  
  return(all_variants_data)
}

extract_variant_info <- function(xml_file_path) {
  cat(xml_file_path, file = stderr())

  xml_file  <- xml2::read_xml(xml_file_path)
  root_node <- xml2::xml_root(xml_file)

  # Helpers s√ªrs
  xtext1 <- function(node, path) {
    n <- xml2::xml_find_first(node, path)
    if (inherits(n, "xml_missing") || length(n) == 0) NA_character_ else xml2::xml_text(n)
  }

  xtext_all_unique <- function(node, path) {
    v <- xml2::xml_find_all(node, path) %>%
      xml2::xml_text() %>%
      unique()
    if (length(v) == 0) NA_character_ else paste(v, collapse = ";")
  }

  # Infos globales
  main_sample_name <- xtext1(root_node, ".//main_sample_name")
  patient_name     <- xtext1(root_node, ".//patient_name")

  # Infos pipeline
  lib         <- xtext_all_unique(root_node, ".//pipelines_def/pipeline_def/lib")
  barcode     <- xtext_all_unique(root_node, ".//pipelines_def/pipeline_def/barcode")
  sample_name <- xtext_all_unique(root_node, ".//pipelines_def/pipeline_def/sample_name")
  design      <- xtext_all_unique(root_node, ".//pipelines_def/pipeline_def/design")

  xml_file_name <- basename(xml_file_path)
  variant_nodes <- xml2::xml_find_all(root_node, ".//variants/variant")

  variants_data <- purrr::map_df(variant_nodes, function(variant) {

    # ===== VAR_FREQ : moyenne des pipelines =====
    var_freq <- {
      vf <- xml2::xml_find_all(
        variant,
        "./pipelines_var_val/pipeline_var_val/var_freq"
      ) %>% xml2::xml_text()

      vf_num <- as.numeric(gsub("%", "", vf))
      if (length(vf_num) == 0) NA_real_ else mean(vf_num, na.rm = TRUE)
    }

    # Champs variant
    chromosome  <- xtext1(variant, "./chromosome")
    position    <- xtext1(variant, "(./position | ./posiition)[1]")
    reference   <- xtext1(variant, "./reference")
    alternative <- xtext1(variant, "./alternative")

    refseq_nodes <- xml2::xml_find_all(variant, "./refseqs/refseq")

    purrr::map_df(refseq_nodes, function(refseq) {
      tibble::tibble(
        main_sample_name = main_sample_name,
        patient_name     = patient_name,
        lib              = lib,
        barcode          = barcode,
        sample_name      = sample_name,
        design           = design,

        chromosome  = chromosome,
        position    = position,
        reference   = reference,
        alternative = alternative,
        var_freq    = var_freq,

        gene                 = xtext1(refseq, "./gene"),
        exon                 = xtext1(refseq, "./exon"),
        function_type        = xtext1(refseq, "./function"),
        transcript           = xtext1(refseq, "./transcript"),
        nucleotidic_position = xtext1(refseq, "./nucleotidic_position"),
        proteinic_position   = xtext1(refseq, "./proteinic_position"),
        prefered_transcript  = xtext1(refseq, "./prefered_transcript"),

        xml_file_name = xml_file_name
      )
    })
  })

  variants_data
}

process_xml_folder_parallel <- function(folder_path,
                                        workers = parallel::detectCores() - 1) {
  xml_files <- list.files(folder_path, pattern = "\\.xml$", full.names = TRUE)

  future::plan(future::multisession, workers = workers)
  on.exit(future::plan(future::sequential), add = TRUE)

  message("üìÇ Fichiers XML trouv√©s : ", length(xml_files))
  message("üöÄ Lancement avec ", workers, " workers")

  res <- future.apply::future_lapply(
    xml_files,
    extract_variant_info
  )

  dplyr::bind_rows(res)
}

clean_prot <- function(x) {
  x %>%
    str_replace_all('"', "") %>%          # enl√®ve les guillemets
    na_if("") %>%
    replace_na("")                        # √©vite NA dans paste
}


```

# BIG
```{r}
################################################################################
# BIG DATA 
################################################################################

(
  read_xlsx("./input/bm/th√®que Big1.xlsx")
  %>% clean_names()
  %>% mutate(type = str_to_upper(type))
) -> raw_bm_BIG

(
  raw_bm_BIG
  %>% group_by(n_inclusion)
  %>% fill(initiale_nom:stade, .direction = "down")
  %>% mutate(n_bm = ifelse(n_inclusion == "12A-010" & stade == "J60 post allo",
  "L1710153", n_bm))
  %>% mutate(n_bm = ifelse(n_bm == "L1714848", "L1714853", n_bm))
  %>% ungroup()
  %>% add_row(n_inclusion = "12A-020", n_bm = "L1816858")
) -> bm_BIG

(
  read_xlsx("./input/bm/BASE BIG1 FINALE 2023 patients 22_07_2024_IDENTITES_POSMYE.xlsx", sheet = 2)
  %>% clean_names()
    %>% add_row(
    "id" = "13A-023",
    "nom" = "VANDENBROUCKE,CAROLINE",
    # "ddn" = ,
    "ndosbm" = "L2311545",
    "posmye" = "UBTF exon 13 c.1335_1341delins82 : p.W445_D447delinsCLSEKKKVRLPGGALSESELTRLLARMC (VAF 50%)\r\nWT1 exon 1 c.646+2dup :  (VAF 40%)\r\nWT1 exon 7 c.1142C>A : p.S381X (VAF 0.81%)\r\nZBTB7A exon 2 c.1204C>T : p.R402C (VAF 3%)",
    # "x6" = ,
    # "x7"   
  )
  %>% add_row(
    "id" = "13A-020",
    "nom" = "CAUDMONT,CLEMENTINE",
    # "ddn" = ,
    "ndosbm" = "L2303763",
    "posmye" = "BCOR exon 2 c.31G>A : p.V11I (VAF 1.01%)\r\nFLT3 exon 14 c.1766_1834dup : p.Y589_E611dup (VAF 2.74%)\r\nMYC exon 2 c.221C>T : p.P74L (VAF 1.38%)\r\nNPM1 exon 11 c.863_864insCCTG : p.W288CfsX12 (VAF 18%)\r\nNRAS exon 2 c.38G>T : p.G13V (VAF 1.11%)\r\nPTPN11 exon 13 c.1505C>T : p.S502L (VAF 1.1%)\r\nRAD21 exon 10 c.1170_1171dup : p.R391HfsX66 (VAF 20%)",
    # "x6" = ,
    # "x7"   
  )
  %>% add_row(
    "id" = "13A-025",
    "nom" = "LEROY,BRUNO",
    # "ddn" = ,
    "ndosbm" = "L2321998",
    "posmye" = "TP53 exon 4 c.227_279del : p.A76VfsX55 (VAF 17%)\r\nTP53 exon 6 c.672G>A : p.E224E (VAF 32%)",
    # "x6" = ,
    # "x7"   
  )
  %>% add_row(
    "id" = "12A-023",
    "nom" = "BRICOUT,YOHANN",
    # "ddn" = ,
    "ndosbm" = "L2319548",
    "posmye" = "ASXL1 exon 12 c.2099_2100insGGCA : p.Y700X (VAF 46%)\r\nNRAS exon 2 c.34G>A : p.G12S (VAF 44%)\r\nWT1 exon 1 c.395del : p.P132RfsX26 (VAF 94%)",
    # "x6" = ,
    # "x7"   
  )
) -> raw_POSMYE

# FICHIER DE CARINE 
(
  read_xlsx("./input/1-LISTE PRE POST GREFFE EN RC1-ALFA-BIG1-02 09 2025.xlsx", sheet = 2, skip = 1)
  %>% clean_names()
  %>% select(id_1:nom_prenom, contains("MOELLE"),  contains("SANG"))
  %>% pivot_longer(diag_moelle:rechute_sang, names_to = "stad", values_to = "ndosbm")
) -> list_ndosbm_BIG

# ALL POSMYE NICO
(
  read_xlsx("./input/bm/POSMYE_BIG.xlsx")
  %>% clean_names()
  %>% mutate(nom = ifelse(nom == "FILO", paste0("BIG,",id), nom))
  %>% rename(ndosbm_diag = ndosbm)
  %>% mutate(nom = str_to_upper(nom))
  %>% mutate(nom = str_replace_all(nom, " ", "_"))
) -> ALL_POSMYE   
```

# 101125
```{r 101125}
################################################################################
# SGE FILE 101125
################################################################################

(
  read_xls("./input/bm/TW-MRD-101125-DRAGEN.xls")
  %>% clean_names()
  %>% filter(projet == "MAGNET_AML")
  %>% count(patient)
) -> nom_run

(
  read_xls("./input/bm/TW-MRD-101125-DRAGEN.xls")
  %>% clean_names()
  %>% filter(projet == "MAGNET_AML")
  %>% select(prelevement)
  %>% mutate(to_keep = TRUE)
  %>% mutate(n_bm = str_remove(prelevement, "D[0-9]{2}"))
) -> ndosbm_run

(
  bm_BIG
  %>% left_join(ndosbm_run)
  %>% group_by(n_inclusion)
  %>% filter(any(to_keep == TRUE))
  %>% filter(to_keep == TRUE | stade == "diag")
  %>% arrange(n_inclusion, desc(stade), desc(ngs))
  %>% group_by(n_inclusion, stade)
  %>% slice(1)
  %>% arrange(n_inclusion, desc(stade), desc(ngs))
  %>% group_by(n_inclusion)
  %>% mutate(n = n())
) -> joined

# (
#   joined 
#   %>% filter(stade %in% c("J30 post allo", "J100 post allo", "3mois post allo", "post allo"))
#   %>% select(n_inclusion, nom, prenom, stade, n_bm)
#   %>% write_tsv(., pipe("pbcopy"))
# ) -> NDU_postG

# (
#   joined
#   # %>% filter(stade == "diag")
# ) -> diag

# (
#   joined
#   %>% mutate(to_keep = ifelse(!is.na(ngs), TRUE, to_keep))
# ) -> perfect_patient


################################################################################
# POSMYE
################################################################################

(
  read_xlsx("./input/bm/BASE BIG1 FINALE 2023 patients 22_07_2024_IDENTITES_POSMYE.xlsx", sheet = 2)
  %>% clean_names()
) -> raw_POSMYE

(
  bm_BIG
  %>% left_join(ndosbm_run)
  %>% filter(to_keep == TRUE)
) -> n_incl_SGE

(
  raw_POSMYE
  %>% filter(id %in% n_incl_SGE$n_inclusion)
) -> POSMYE_101125

(
  POSMYE_101125
  %>% filter(!is.na(x7))
  %>% mutate(x6 = str_extract(x6, "L.*"))
  # %>% select(x6)
) -> SQXT_ndosbm

# write_tsv(SQXT_ndosbm, "./input/bm/XML/SSQXT_101125.tsv")

################################################################################
# OPEN XML
################################################################################

all_variants_data <- process_xml_folder("./input/bm/XML/selected_101125/")

(
  all_variants_data
  %>% mutate(ndosbm = str_remove(xml_file_name, "D[0-9]{2}.xml"))
  %>% select(ndosbm, nucleotidic_position, chromosome, position, reference, alternative)
  %>% distinct()
  %>% ungroup()
) -> variant_data

list_gene_LOVER_2023 <- "ABCB11|ABL1|ABO|ANKRD26|ARID1A|ASXL1|ASXL2|ATG2B|ATM|ATRX|B2M|BAX|BCL2|BCOR|BCORL1|BIRC3|BRAF|BTG1|BTK|CALR|CARD11|CBL|CCL22|CCND1|CCND3|CCR4|CD274|CD28|CD58|CD79A|CD79B|CDKN2A|CDKN2B|CEBPA|CHEK2|CIITA|COG1|CREBBP|CRLF2|CSF2RA|CSF2RB|CSF3R|CTCF|CUX1|CXCR4|DDX3X|DDX41|DHX15|DHX34|DNMT3A|EBF1|EGLN1|EGR2|EP300|EPAS1|EPO|EPOR|ERG|ETNK1|ETV6|EVC|EZH2|F8|F9|F9|FBXW7|FERMT1|FGFR1|FIP1L1|FLT3|FOXO1|GATA1|GATA2|GNA13|GNAS|GNB1|GRM1|GSKIP|HRAS|ID3|IDH1|IDH2|IKZF1|IKZF3|IL2RG|IL3RA|IL5RA|IL7R|IRF4|ITPKB|JAK1|JAK2|JAK3|JUNB|KDM6A|KIT|KLF2|KMT2A|KMT2D|KRAS|L2HGDH|LAMA3|LUC7L2|MAP2K1|MAP3K14|MBD4|MEF2B|MPL|MSC|MYC|MYD88|NDUFV3|NF1|NFE2|NIPBL|NOTCH1|NOTCH2|NPHS2|NPM1|NRAS|NSD2|WHSC1|P2RY8|PAX5|PDGFRA|PDGFRB|PHF6|PIGA|PIM1|PLCG1|PLCG2|POT1|PPM1D|PRDM1|PROC|PROS1|PRPF8|PTEN|PTPN11|PTPRD|RAD21|RB1|RHOA|RIT1|RPS15|RUNX1|SAMD9|SAMD9L|SBDS|SERPINC1|SETBP1|SETD2|SF3B1|SH2B3|SLC12A6|SMC1A|SMC3|SOCS1|SOX6|SPI1|SRP72|SRSF2|SRY|STAG2|STAT1|STAT3|STAT5A|STAT5B|STAT6|TBL1XR1|TCF3|TCL1A|TDRD7|TERC|TERT|TET2|TNFAIP3|TNFRSF14|TP53|TYK2|U2AF1|UBA1|UBTF|VAV1|VCAN|VHL|VWF|WNK1|WT1|XPO1|ZBTB7A|ZRSR2"

################################################################################
# 54 p avec run SSQXT (2 NEG)
################################################################################

(
  SQXT_ndosbm
  %>% separate_rows(posmye, sep = "\r\n")
  %>% mutate(gene = str_extract(posmye, list_gene_LOVER_2023))
  %>% mutate(vaf = str_extract(posmye, "\\d+(\\.\\d+)?%")) 
  %>% mutate(vaf = as.numeric(str_remove(vaf, "%")))
  %>% mutate(c. = str_extract(posmye, "c.* :"))
  %>% mutate(c. = ifelse(is.na(c.), str_extract(posmye, "c.* \\("),c.))
  %>% mutate(c. = str_remove(c., "( :)| \\("))
  %>% mutate(p. = str_extract(posmye, "p\\..*\\("))
  %>% mutate(p. = str_remove(p., "\\("))
  %>% mutate(p. = ifelse(is.na(p.), "p.intron", p.))
  %>% mutate(mutation = paste0(gene, "_", p.))
  %>% mutate(gene = case_when(
    gene == "FLT3" & str_detect(c., "dup|in") ~ "FLT3-ITD",
    gene == "FLT3" & str_detect(c., ">") ~ "FLT3-TKD",
    TRUE ~ gene
  ))
  %>% select(-p.)
  %>% left_join(variant_data, by=c("ndosbm", "c." = "nucleotidic_position"))
  %>% group_by(gene, `c.`)
  %>% fill(chromosome, position, reference, alternative,
       .direction = "downup")
  %>% ungroup()
  %>% filter(posmye != "Analyse n√©gative")
) -> SQXT_ndosbm_row

length(unique(SQXT_ndosbm_row$ndosbm))

(
  POSMYE_101125
  %>% filter(is.na(x7))
  %>% mutate(x6 = str_extract(x6, "L.*"))
  # %>% select(ndosbm)
  # %>% write_tsv(., pipe("pbcopy"))
  %>% filter(posmye != "Analyse n√©gative.")
  %>% filter(posmye != ".")
) -> ndosbm_missing

(
  read_tsv("./input/bm/XML/selected_missing_101125/missing_ndosbm_101125.tsv",
  col_names = c("name", "path", "date"))
  %>% filter(!str_detect(path, "TW-MRD|BIOCOMPUTING|GROUP"))
  %>% arrange(name, desc(date))
  %>% group_by(name)
  %>% slice(1)
  %>% ungroup()
) -> path_ndosbm_missing

all_variants_data <- process_xml_folder("./input/bm/XML/selected_missing_101125/")

(
  all_variants_data
  %>% mutate(ndosbm = str_remove(xml_file_name, "D[0-9]{2}.xml"))
  %>% select(ndosbm, nucleotidic_position, chromosome, position, reference, alternative)
  %>% distinct()
  %>% ungroup()
) -> variant_data


(
  ndosbm_missing
  %>% separate_rows(posmye, sep = "\r\n")
  %>% mutate(gene = str_extract(posmye, list_gene_LOVER_2023))
  %>% mutate(vaf = str_extract(posmye, "\\d+(\\.\\d+)?%")) 
  %>% mutate(vaf = as.numeric(str_remove(vaf, "%")))
  %>% mutate(c. = str_extract(posmye, "c.* :"))
  %>% mutate(c. = ifelse(is.na(c.), str_extract(posmye, "c.* \\("),c.))
  %>% mutate(c. = str_remove(c., "( :)| \\("))
  %>% mutate(p. = str_extract(posmye, "p\\..*\\("))
  %>% mutate(p. = str_remove(p., "\\("))
  %>% mutate(p. = ifelse(is.na(p.), "p.intron", p.))
  %>% mutate(mutation = paste0(gene, "_", p.))
  %>% mutate(gene = case_when(
    gene == "FLT3" & str_detect(c., "dup|in") ~ "FLT3-ITD",
    gene == "FLT3" & str_detect(c., ">") ~ "FLT3-TKD",
    TRUE ~ gene
  ))
  %>% select(-p.)
  %>% left_join(variant_data, by=c("ndosbm", "c." = "nucleotidic_position"))
  %>% group_by(gene, `c.`)
  %>% fill(chromosome, position, reference, alternative,
       .direction = "downup")
  %>% ungroup()
  %>% filter(posmye != "Analyse n√©gative")
) -> ndosbm_missing_row

(
  SQXT_ndosbm_row
  %>% bind_rows(ndosbm_missing_row)
  %>% left_join(bm_BIG %>% select(ndosbm = n_bm, ddp))
  %>% filter(!str_detect(nom, "PLAINE"))
  %>% rename(ndosbm_diag = ndosbm)
) -> all_by_row

missing_incl <- setdiff(n_incl_SGE$n_inclusion, unique(all_by_row$id))

(
  bm_BIG
  %>% filter(n_inclusion %in% missing_incl)
  %>% filter(stade == "diag")
  %>% filter(type == "MO" | type == "mO")
) -> missing_incl_diag

# path_ndosbm_missing %>% select(path) %>% write_tsv("./output/bm/path_ndosbm_missing.tsv")

(
  read_tsv("./input/bm/XML/selected_nincl_101125/missing_incl_diag.tsv")
  %>% filter(str_detect(PATH, "xml"))
) -> n_incl_path

# all_variants_data <- process_xml_folder("./input/bm/XML/selected_nincl_101125/")

(
  all_variants_data
  %>% mutate(ndosbm = str_remove(xml_file_name, "D[0-9]{2}.xml"))
  %>% select(ndosbm, nucleotidic_position, chromosome, position, reference, alternative)
  %>% distinct()
  %>% ungroup()
) -> variant_data

(
  n_incl_SGE
  %>% select(n_inclusion, ndosbm_suivi = n_bm)
  %>% left_join(POSMYE_101125 %>% select(n_inclusion = id, ndosbm_diag = ndosbm))
  %>% mutate(to_drop = FALSE, .before = "n_inclusion")
  %>% mutate(to_drop = ifelse(!str_detect(ndosbm_diag, "L"), TRUE, to_drop))
  %>% mutate(to_drop = ifelse(n_inclusion %in% c("19A-004", "22A-048", "14A-003", "01A-029"), TRUE, to_drop))
) -> correspondance_diag_suivi

(
  correspondance_diag_suivi
  %>% group_by(n_inclusion)
  %>% mutate(n = n())
  %>% ungroup()
  %>% filter(to_drop == FALSE)
  %>% left_join(all_by_row)
  %>% mutate(transcript = "")
  %>% mutate(exon = "")
  %>% left_join(bm_BIG %>% select(ndosbm_suivi = n_bm, date_suivi = ddp))
  %>% select(ndosbm_diag, lib=x7,	gene, chromosome, position, reference, 
  alternative, transcript, exon, nucleotidic_position = `c.`,	
  proteinic_position = mutation, vaf_percent = vaf, ndosbm_suivi, date_suivi,
   nom_patient = nom, DDG = ddp)
   %>% arrange(nom_patient, ndosbm_suivi)
   %>% mutate(proteinic_position = str_extract(proteinic_position, "p.*"))
) -> FC_101125

length(unique(FC_101125$ndosbm_suivi))

# writexl::write_xlsx(FC_101125, "./output/bm/FC_MAGNET_AML_101125.xlsx")

# (
#   read_xlsx("./output/bm/FC_MAGNET_AML_101125.xlsx")
#   %>% distinct(ndosbm_diag)
#   %>% nrow()
# )

```

* 81 total list SGE

* DISPO CASH 54
  * DECOURCELLE erreur meme L1706711 pour pr√©-greffe et J60 post allo
    * Modif 12A-010 J60 post allo L1710153
  * MISSING : "L1714853" "L1816858"
  * Modification DUPIN L1714848 to L1714853
  * ANALYSE NEGATINVE : 
    * 19A-004 LEMAIRE,Maxime
    * 22A-048 DRUJONT,Nicolas

* NON DISPO CASH 19
  * 01A-029 GILLARD BOTTEQUIN,LEA NEG 
  * A priori RUIZ SERRANO,GERARD pas de diag 
  * PLAINE,EMILIE ADN326-94_DG ?? 

* 71 total , 3 AN 1 NR = 75

* no incl "01A-029" r√©cup√©rer 
* AUCUNE TRACE sur tout onco h√©mato "14A-003" "19A-004" "22A-048"
* m√™me patient plusieurs samples

* Analyse n√©gative 

* AU TOTAL 81 fichiers SGE 
  * 5 D√©gager : 
    * 01A-029 NEG
    * 14A-003 NR
    * 19A-004 NEG
    * 22A-046 ADN326-94_DG ? 
    * 22A-048 NEG

* AJOUTER MANUELLEMENT c.330G>T PLAINE EMILIE

* Suppresion du variant RUNX1 NOEL,FRE
* Supression du variant FLT3 DUPIN

# 191125

* 36 p MAGNET_AML

```{r}

################################################################################
# BIG INFOS SAMPLE
################################################################################



(
  read_xlsx("./input/RUN_191125.xlsx")
  %>% clean_names()
  %>% filter(projet == "MAGNET_AML")
  # %>% mutate(
  #   ddp = case_when(
  #     str_detect(ddp, "^\\d+$") ~ as_date(as.numeric(ddp), origin = "1899-12-30"),
  #     TRUE                        ~ dmy(ddp)
  #   )
  # )
  %>% mutate(ndosbm = str_remove(prelevement, "D[0-9]{1,2}"))
  %>% select(patient, ndosbm)
  %>% mutate(to_keep = TRUE)
  # %>% select(ndosbm)
  # %>% write_tsv(., pipe("pbcopy"))
) -> list_run_mrd191125

# 36 samples 

(
  bm_BIG
  %>% left_join(list_run_mrd191125, by = c("n_bm" = "ndosbm"))
  %>% group_by(n_inclusion)
  %>% filter(any(to_keep == TRUE))
  %>% filter(to_keep == TRUE | stade == "diag")
  %>% arrange(n_inclusion, desc(stade), desc(ngs))
  %>% group_by(n_inclusion, stade)
  %>% slice(1)
  # %>% arrange(n_inclusion, desc(stade), desc(ngs))
  # %>% group_by(n_inclusion)
  # %>% mutate(n = n())
  %>% ungroup()
  %>% filter(stade == "diag")
  # %>% select(n_bm)
  # %>% write_tsv(., pipe("pbcopy"))
) -> joined

# 4 patients avec 2 points
# 32 patients donc 

# 22A-022 pas de ndosbm

################################################################################
# POSMYE
################################################################################

(
  read_xlsx("./input/bm/BASE BIG1 FINALE 2023 patients 22_07_2024_IDENTITES_POSMYE.xlsx", sheet = 2)
  %>% clean_names()
) -> raw_POSMYE

(
  bm_BIG
  %>% left_join(list_run_mrd191125, by = c("n_bm" = "ndosbm"))
  %>% filter(to_keep == TRUE)
) -> n_incl_SGE_191125

(
  raw_POSMYE
  %>% filter(id %in% n_incl_SGE_191125$n_inclusion)
) -> POSMYE_191125

(
  POSMYE_191125
  %>% filter(!is.na(x7))
  %>% mutate(x6 = str_extract(x6, "L.*"))
  # %>% select(ndosbm)
  # %>% write_tsv(., pipe("pbcopy"))
) -> SQXT_ndosbm_191125

# 3 NA 
# AUMONT, ERIC
# ARICAN, JACQUES
# JARNIGON, AXEL

# 29 patients

################################################################################
# OPEN XML
################################################################################

all_variants_data <- process_xml_folder("/Users/augustin_boudry/R/projets/251104_MAGNET_AML/input/bm/XML/191125_selected")

(
  all_variants_data
  %>% mutate(ndosbm = str_remove(xml_file_name, "D[0-9]{2}.xml"))
  %>% select(ndosbm, nucleotidic_position, chromosome, position, reference, alternative)
  %>% distinct()
  %>% ungroup()
) -> variant_data

length(unique(variant_data$ndosbm))


(
  SQXT_ndosbm_191125
  %>% separate_rows(posmye, sep = "\r\n")
  %>% mutate(gene = str_extract(posmye, list_gene_LOVER_2023))
  %>% mutate(vaf = str_extract(posmye, "\\d+(\\.\\d+)?%")) 
  %>% mutate(vaf = as.numeric(str_remove(vaf, "%")))
  %>% mutate(c. = str_extract(posmye, "c.* :"))
  %>% mutate(c. = ifelse(is.na(c.), str_extract(posmye, "c.* \\("),c.))
  %>% mutate(c. = str_remove(c., "( :)| \\("))
  %>% mutate(p. = str_extract(posmye, "p\\..*\\("))
  %>% mutate(p. = str_remove(p., "\\("))
  %>% mutate(p. = ifelse(is.na(p.), "p.intron", p.))
  %>% mutate(mutation = paste0(gene, "_", p.))
  %>% mutate(gene = case_when(
    gene == "FLT3" & str_detect(c., "dup|in") ~ "FLT3-ITD",
    gene == "FLT3" & str_detect(c., ">") ~ "FLT3-TKD",
    TRUE ~ gene
  ))
  %>% select(-p.)
  %>% left_join(variant_data, by=c("ndosbm", "c." = "nucleotidic_position"))
  %>% group_by(gene, `c.`)
  %>% fill(chromosome, position, reference, alternative,
       .direction = "downup")
  %>% ungroup()
  %>% filter(posmye != "Analyse n√©gative")
  %>% ungroup()
) -> SQXT_ndosbm_row

length(unique(SQXT_ndosbm_row$ndosbm))

(
  POSMYE_101125
  %>% filter(is.na(x7))
  %>% mutate(x6 = str_extract(x6, "L.*"))
  # %>% select(ndosbm)
  # %>% write_tsv(., pipe("pbcopy"))
  %>% filter(posmye != "Analyse n√©gative.")
  %>% filter(posmye != ".")
) -> ndosbm_missing

(
  n_incl_SGE_191125
  %>% select(n_inclusion, ndosbm_suivi = n_bm)
  %>% left_join(POSMYE_191125 %>% select(n_inclusion = id, ndosbm_diag = ndosbm))
  %>% mutate(to_drop = FALSE, .before = "n_inclusion")
  %>% mutate(to_drop = ifelse(!str_detect(ndosbm_diag, "L"), TRUE, to_drop))
) -> correspondance_diag_suivi


(
  correspondance_diag_suivi
  %>% group_by(n_inclusion)
  %>% mutate(n = n())
  %>% ungroup()
  %>% filter(to_drop == FALSE)
  %>% left_join(SQXT_ndosbm_row %>% rename(ndosbm_diag = ndosbm))
  %>% mutate(transcript = "")
  %>% mutate(exon = "")
  %>% left_join(bm_BIG %>% select(ndosbm_diag = n_bm, DDG = ddp))
  %>% left_join(bm_BIG %>% select(ndosbm_suivi = n_bm, date_suivi = ddp))
  %>% select(ndosbm_diag, lib=x7,	gene, chromosome, position, reference, 
  alternative, transcript, exon, nucleotidic_position = `c.`,	
  proteinic_position = mutation, vaf_percent = vaf, ndosbm_suivi, date_suivi,
   nom_patient = nom, DDG)
   #  DDG = ddp
   %>% arrange(nom_patient, ndosbm_suivi)
   %>% mutate(proteinic_position = str_extract(proteinic_position, "p.*"))
   %>% filter(ndosbm_diag != "L1602636")
   %>% filter(ndosbm_diag != "L1606609")
) -> FC_191125

writexl::write_xlsx(FC_191125, "./output/191125_FC_MAGNET_AML.xlsx")

length(unique(FC_191125$nom_patient))


```

# TW-MRD-021225
```{r}
(
  read_xls("./input/bm/TW-MRD-031225-DRAGEN.xls")
  %>% clean_names()
  %>% filter(projet == "MAGNET_AML")
  # %>% count(patient)
  # %>% filter(n > 1)
) -> nom_run

# 6 patients en doubles 

(
  read_xls("./input/bm/TW-MRD-031225-DRAGEN.xls")
  %>% clean_names()
  %>% filter(projet == "MAGNET_AML")
  %>% select(prelevement,patient)
  # %>% mutate(to_keep = TRUE)
  %>% mutate(n_bm = str_remove(prelevement, "D[0-9]{2}"))
  %>% left_join(list_ndosbm, by = c("n_bm" = "ndosbm"))
  %>% filter(!str_detect(patient, "BIG,"))
) -> ndosbm_run


(
  list_ndosbm
  %>% mutate(to_keep = ndosbm %in% ndosbm_run$n_bm)
  %>% group_by(id_1)
  %>% filter(any(to_keep))
  %>% filter(str_detect(stad, "diag"))
  %>% filter(!is.na(ndosbm))
  %>% arrange(id_1, stad)
  %>% slice(1)
  %>% select(id_1, ndosbm_diag = ndosbm)
) -> list_diag

setdiff(ndosbm_run$id_1, tmp$id_1)
# 71 + 6 + 2 = 79 on retombe sur nos pates 
# 2 PATIENTS 25A-048 25A-053 RIEN AU DIAG RECUP RC1 ? 

(
  ndosbm_run
  %>% rename(ndosbm_suivi = n_bm)
  %>% left_join(list_diag)
  %>% filter(!is.na(ndosbm_diag))
) -> ndosbm_run_diag_suivi

(
  read_xls("./input/bm/TW-MRD-031225-DRAGEN.xls")
  %>% clean_names()
  %>% filter(projet == "MAGNET_AML")
  %>% select(prelevement,patient)
  # %>% mutate(to_keep = TRUE)
  %>% mutate(n_bm = str_remove(prelevement, "D[0-9]{2}"))
  %>% left_join(list_ndosbm, by = c("n_bm" = "ndosbm"))
  %>% filter(str_detect(patient, "BIG,"))
) -> ndosbm_run_BIG

# 77 

(
  raw_POSMYE
  %>% filter(id %in% ndosbm_run_diag_suivi$id_1)
  %>% filter(!str_detect(posmye, "n√©gative"))
  %>% filter(posmye != ".")
  # %>% select(ndosbm)
  # # %>% write_tsv(., pipe("pbcopy"))
) -> POSMYE_021225

# 71 + 6 = 77 
# - 3 ana neg ou . = 68


(
  read_tsv("./input/bm/path_021215.tsv")
  %>% clean_names()
  %>% filter(!is.na(path))
) -> path_xml

# 11 missing = 57

(
  read_tsv("./input/bm/path_021215.tsv")
  %>% clean_names()
  %>% filter(is.na(path))
) -> path_xml_missing

(
  read_tsv("./input/bm/path_021215.tsv")
  %>% clean_names()
  %>% filter(!is.na(path))
  %>% filter(!str_detect(path, "GROUP-100"))
  %>% group_by(id)
  %>% slice_max(date)
  # %>% ungroup()
  # %>% select(path, -id)
  # %>% write_tsv(., pipe("pbcopy"))
) -> path_xml

# (
#   SSQXT_POSMYE_021225
#   %>% select(x6)
#   %>% write_tsv(., pipe("pbcopy"))
# )

all_variants_data <- process_xml_folder("./input/bm/XML/selected_021225/")

(
  all_variants_data
  %>% mutate(ndosbm = str_remove(xml_file_name, "D[0-9]{2}.xml"))
  %>% select(ndosbm, nucleotidic_position, chromosome, position, reference, alternative)
  %>% distinct()
  %>% ungroup()
) -> variant_data

length(unique(variant_data$ndosbm))

(
  POSMYE_021225
  %>% ungroup()
  %>% filter(!(ndosbm %in% path_xml_missing$id))
  %>% separate_rows(posmye, sep = "\r\n")
  %>% mutate(gene = str_extract(posmye, list_gene_LOVER_2023))
  %>% mutate(vaf = str_extract(posmye, "\\d+(\\.\\d+)?%")) 
  %>% mutate(vaf = as.numeric(str_remove(vaf, "%")))
  %>% mutate(c. = str_extract(posmye, "c.* :"))
  %>% mutate(c. = ifelse(is.na(c.), str_extract(posmye, "c.* \\("),c.))
  %>% mutate(c. = str_remove(c., "( :)| \\("))
  %>% mutate(p. = str_extract(posmye, "p\\..*\\("))
  %>% mutate(p. = str_remove(p., "\\("))
  %>% mutate(p. = ifelse(is.na(p.), "p.intron", p.))
  %>% mutate(mutation = paste0(gene, "_", p.))
  %>% mutate(gene = case_when(
    gene == "FLT3" & str_detect(c., "dup|in") ~ "FLT3-ITD",
    gene == "FLT3" & str_detect(c., ">") ~ "FLT3-TKD",
    TRUE ~ gene
  ))
  %>% select(-p.)
  %>% left_join(variant_data, by=c("ndosbm", "c." = "nucleotidic_position"))
  %>% group_by(gene, `c.`)
  %>% fill(chromosome, position, reference, alternative,
       .direction = "downup")
  %>% ungroup()
  %>% filter(posmye != "Analyse n√©gative")
  %>% ungroup()
  %>% filter(posmye != "")
  %>% mutate(
    chromosome = case_when(
      str_detect(mutation, "WT1_p.R370PfsX15") ~ "chr11",
      TRUE ~ chromosome
    ),
    position = case_when(
      str_detect(mutation, "WT1_p.R370PfsX15") ~ "32417943",
      TRUE ~ position
    ),
    reference = case_when(
      str_detect(mutation, "WT1_p.R370PfsX15") ~ "C",
      TRUE ~ reference
    ),
    alternative = case_when(
      str_detect(mutation, "WT1_p.R370PfsX15") ~ "CG",
      TRUE ~ alternative
    )
  )
  %>% mutate(
    chromosome = case_when(
      str_detect(mutation, "WT1_p.A382SfsX7") ~ "chr11",
      TRUE ~ chromosome
    ),
    position = case_when(
      str_detect(mutation, "WT1_p.A382SfsX7") ~ "332417909",
      TRUE ~ position
    ),
    reference = case_when(
      str_detect(mutation, "WT1_p.A382SfsX7") ~ "C",
      TRUE ~ reference
    ),
    alternative = case_when(
      str_detect(mutation, "WT1_p.A382SfsX7") ~ "CGACCGTACAAGAG",
      TRUE ~ alternative
    )
  )
  %>% mutate(
    chromosome = case_when(
      str_detect(mutation, "PTPN11_p.P491L") ~ "chr12",
      TRUE ~ chromosome
    ),
    position = case_when(
      str_detect(mutation, "PTPN11_p.P491L") ~ "112926852",
      TRUE ~ position
    ),
    reference = case_when(
      str_detect(mutation, "PTPN11_p.P491L") ~ "C",
      TRUE ~ reference
    ),
    alternative = case_when(
      str_detect(mutation, "PTPN11_p.P491L") ~ "T",
      TRUE ~ alternative
    )
  )
  %>% mutate(
    chromosome = case_when(
      str_detect(c., "c.863_864insCATG") ~ "chr5",
      TRUE ~ chromosome
    ),
    position = case_when(
      str_detect(c., "c.863_864insCATG") ~ "170837545",
      TRUE ~ position
    ),
    reference = case_when(
      str_detect(c., "c.863_864insCATG") ~ "C",
      TRUE ~ reference
    ),
    alternative = case_when(
      str_detect(c., "c.863_864insCATG") ~ "CTGCA",
      TRUE ~ alternative
    )
  )
  %>% mutate(
    chromosome = case_when(
      str_detect(c., "c.1795_1805delinsAGCCAGCTACAG") ~ "chr13",
      TRUE ~ chromosome
    ),
    position = case_when(
      str_detect(c., "c.863_864insCATG") ~ "28608261",
      TRUE ~ position
    ),
    reference = case_when(
      str_detect(c., "c.863_864insCATG") ~ "A",
      TRUE ~ reference
    ),
    alternative = case_when(
      str_detect(c., "c.863_864insCATG") ~ "ATTCATATTCTCTGAAATCAACGTAGAAGTACTCATTATCTGAGGAGCCGGTCACCTGTACCATCTGTAGCTGGCT",
      TRUE ~ alternative
    )
  )
  # %>% mutate(chromosome = ifelse(nom == "DIJON,VALERIE" & gene == "NPM1", "chr5", chromosome))
) -> ndosbm_row

(
  ndosbm_row
  %>% left_join(ndosbm_run %>% rename(id = id_1))
  %>% rename(
    ndosbm_diag = ndosbm,
    ndosbm_suivi = n_bm
  )
  %>% mutate(date_suivi = "")
  %>% mutate(ddp = "")
  %>% mutate(transcript = "")
  %>% mutate(exon = "")
  %>% select(ndosbm_diag, lib=x7,	gene, chromosome, position, reference, 
  alternative, transcript, exon, nucleotidic_position = `c.`,	
  proteinic_position = mutation, vaf_percent = vaf, ndosbm_suivi, date_suivi,
   nom_patient = nom, DDG = ddp)
) -> classic

length(unique(ndosbm_row$ndosbm))

################################################################################
# BIG
################################################################################

# 16 samples 

(
  read_xlsx("./input/bm/XML/BIG_selected_021225/BIG FILO AB.xlsx")
  %>% clean_names()
  %>% filter(posmye != "Analyse n√©gative")
  %>% select(id = patient_id, nom = nom_prenom, ndosbm, posmye)
) -> BIG_021225

(
  read_tsv("./input/bm/XML/selected_BIG_021225/id_BIG021225.tsv")
  %>% clean_names()
  %>% filter(id != "L2102453")
  %>% filter(str_detect(path, "patient"))
  %>% filter(!str_detect(path, "GROUP"))
  %>% filter(!str_detect(path, "100000"))
  %>% group_by(id)
  %>% slice_max(date)
  %>% ungroup()
  %>% select(path)
  %>% write_tsv(., pipe("pbcopy"))
) -> BIG_path

# -1 Analyse neg 15 

all_variants_data_BIG <- process_xml_folder("./input/bm/XML/selected_BIG_021225/")

(
  all_variants_data_BIG
  %>% mutate(ndosbm = str_remove(xml_file_name, "D[0-9]{2}.xml"))
  %>% select(ndosbm, nucleotidic_position, chromosome, position, reference, alternative)
  %>% distinct()
  %>% ungroup()
) -> variant_data_BIG

(
  BIG_021225
  %>% ungroup()
  %>% separate_rows(posmye, sep = "\r\n")
  %>% mutate(gene = str_extract(posmye, list_gene_LOVER_2023))
  %>% mutate(vaf = str_extract(posmye, "\\d+(\\.\\d+)?%")) 
  %>% mutate(vaf = as.numeric(str_remove(vaf, "%")))
  %>% mutate(c. = str_extract(posmye, "c.* :"))
  %>% mutate(c. = ifelse(is.na(c.), str_extract(posmye, "c.* \\("),c.))
  %>% mutate(c. = str_remove(c., "( :)| \\("))
  %>% mutate(c. = ifelse(c. == "c.1334_1335ins60 p.M444_W445insc.1334_1335ins60 :", "c.1334_1335insCCTCCGAGAGCGAGCTGACCCAGCCGAGAGCGAGCTGACCCGCCTGCTGGCCCGAATGTG", c.))
  %>% mutate(p. = str_extract(posmye, "p\\..*\\("))
  %>% mutate(p. = str_remove(p., "\\("))
  %>% mutate(p. = ifelse(is.na(p.), "p.intron", p.))
  %>% mutate(mutation = paste0(gene, "_", p.))
  %>% mutate(gene = case_when(
    gene == "FLT3" & str_detect(c., "dup|in") ~ "FLT3-ITD",
    gene == "FLT3" & str_detect(c., ">") ~ "FLT3-TKD",
    TRUE ~ gene
  ))
  %>% select(-p.)
  %>% left_join(variant_data_BIG, by=c("ndosbm", "c." = "nucleotidic_position"))
  %>% group_by(gene, `c.`)
  %>% fill(chromosome, position, reference, alternative,
       .direction = "downup")
  %>% ungroup()
  %>% filter(posmye != "")
  %>% filter(posmye != "")
  # %>% mutate(chromosome = ifelse(nom == "DIJON,VALERIE" & gene == "NPM1", "chr5", chromosome))
) -> ndosbm_row_BIG

(
  read_xls("./input/bm/TW-MRD-031225-DRAGEN.xls")
  %>% clean_names()
  %>% filter(projet == "MAGNET_AML")
  %>% select(prelevement,patient)
  # %>% mutate(to_keep = TRUE)
  %>% mutate(n_bm = str_remove(prelevement, "D[0-9]{2}"))
  %>% left_join(list_ndosbm, by = c("n_bm" = "ndosbm"))
  %>% filter(str_detect(patient, "BIG,"))
) -> ndosbm_run_BIG

(
  ndosbm_row_BIG
  %>% left_join(ndosbm_run_BIG %>% rename(nom = patient))
  %>% rename(
    ndosbm_diag = ndosbm,
    ndosbm_suivi = n_bm
  )
  %>% mutate(date_suivi = "")
  %>% mutate(ddp = "")
  %>% mutate(transcript = "")
  %>% mutate(exon = "")
  %>% mutate(lib = "")
  %>% select(ndosbm_diag, lib,	gene, chromosome, position, reference, 
  alternative, transcript, exon, nucleotidic_position = `c.`,	
  proteinic_position = mutation, vaf_percent = vaf, ndosbm_suivi, date_suivi,
   nom_patient = nom, DDG = ddp)
) -> BIG

################################################################################
# NULL PATH
################################################################################

all_variants_data_no_path <- process_xml_folder("./input/bm/XML/selected_021225_no_path/selected/")

(
  all_variants_data_no_path
  %>% mutate(ndosbm = str_remove(xml_file_name, "D[0-9]{2}.xml"))
  %>% select(ndosbm, nucleotidic_position, chromosome, position, reference, alternative)
  %>% distinct()
  %>% ungroup()
) -> variant_data_no_path

(
  POSMYE_021225
  %>% filter(ndosbm %in% path_xml_missing$id)
) -> no_path

(
  no_path
  %>% ungroup()
  %>% separate_rows(posmye, sep = "\r\n")
  %>% mutate(gene = str_extract(posmye, list_gene_LOVER_2023))
  %>% mutate(gene = ifelse(id == "14A-013", "BCORL1", gene))
  %>% mutate(vaf = str_extract(posmye, "\\d+(\\.\\d+)?%")) 
  %>% mutate(vaf = as.numeric(str_remove(vaf, "%")))
  %>% mutate(c. = str_extract(posmye, "c.* :"))
  %>% mutate(c. = ifelse(is.na(c.), str_extract(posmye, "c.* \\("),c.))
  %>% mutate(c. = str_remove(c., "( :)| \\("))
  %>% mutate(p. = str_extract(posmye, "p\\..*\\("))
  %>% mutate(p. = str_remove(p., "\\("))
  %>% mutate(p. = ifelse(is.na(p.), "p.intron", p.))
  %>% mutate(mutation = paste0(gene, "_", p.))
  %>% mutate(gene = case_when(
    gene == "FLT3" & str_detect(c., "dup|in") ~ "FLT3-ITD",
    gene == "FLT3" & str_detect(c., ">") ~ "FLT3-TKD",
    TRUE ~ gene
  ))
  %>% select(-p.)
  %>% left_join(variant_data_no_path, by=c("ndosbm", "c." = "nucleotidic_position"))
  %>% group_by(gene, `c.`)
  %>% fill(chromosome, position, reference, alternative,
       .direction = "downup")
  %>% ungroup()
  %>% filter(posmye != "")
  %>% filter(posmye != "")
  # %>% mutate(chromosome = ifelse(nom == "DIJON,VALERIE" & gene == "NPM1", "chr5", chromosome))
) -> ndosbm_row_no_path

(
  ndosbm_row_no_path
  %>% left_join(ndosbm_run %>% rename(id = id_1))
  %>% rename(
    ndosbm_diag = ndosbm,
    ndosbm_suivi = n_bm
  )
  %>% mutate(date_suivi = "")
  %>% mutate(ddp = "")
  %>% mutate(transcript = "")
  %>% mutate(exon = "")
  %>% mutate(lib = "")
  %>% select(ndosbm_diag, lib,	gene, chromosome, position, reference, 
  alternative, transcript, exon, nucleotidic_position = `c.`,	
  proteinic_position = mutation, vaf_percent = vaf, ndosbm_suivi, date_suivi,
   nom_patient = nom, DDG = ddp)
) -> no_path

# MAOUCHE,SOUHAILA Faire la main 

(
  classic
  %>% bind_rows(BIG)
  %>% bind_rows(no_path)
  %>% arrange(nom_patient, ndosbm_suivi)
) -> ALL_021225

length(unique(ALL_021225$ndosbm_suivi))
# TOTAL 89 patients + 2 PATIENTS 25A-048 25A-053 + 3 ana neg ou . + 1 neg = 95 on est bon 

setdiff(nom_run %>% mutate(ndosbm_suivi = str_extract(prelevement, "L[0-9]{7}")) %>% pull(ndosbm_suivi), unique(ALL_021225$ndosbm_suivi))
#[1] "L1612407" "L1612549" "L2007854" "L2016197" "L2103516" "L2510714"

# writexl::write_xlsx(ALL_021225, "./output/021225mut_to_track.xlsx")

# INTROUVABLE 
# L2105548		CEBPA							c.109_127del	CEBPA_p.intron		L2109216		MAOUCHE,SOUHAILA	
# L2105548		CEBPA							c.936_937insCAA	CEBPA_p.intron		L2109216		MAOUCHE,SOUHAILA	
```

# TW-MRD-161225
* 89 patients au total 
  * -2 pas de diag 
  * -4 diag neg
```{r}
(
  read_xlsx("./input/bm/TW-MRD-DRAGEN-161225.xlsx")
  %>% clean_names()
  # %>% count(patient)
  # %>% filter(n > 1)
  %>% filter(prelevement != "T-NEG-161225")
  # %>% filter(prelevement != "L2510791D01")
  # %>% filter(prelevement != "L2510790D01")
  %>% mutate(n_bm = str_remove(prelevement, "D[0-9]{2}"))
  # %>% left_join(list_ndosbm, by = c("n_bm" = "ndosbm"))
  %>% left_join(ALL_POSMYE, by = c("patient" = "nom"))
  # %>% select(ndosbm_diag)
  # %>% write_tsv(., pipe("pbcopy"))
) -> RUN_161225



(
  RUN_161225
  %>% select(ndosbm_diag, ndosbm_suivi = prelevement)
  %>% left_join(path_161225 %>% filter(folder == "patient"), by = c("ndosbm_diag" = "id"))
  %>% mutate(tmp = str_extract(path, paste0(ndosbm_diag, "D[0-9]{2}")))
  %>% select(ndosbm_diag = tmp, ndosbm_suivi)
  %>% filter(!is.na(ndosbm_diag))
) -> extract_base

write_csv(extract_base, "./output/TW-MRD-161225.csv")

# writexl::write_xlsx(RUN_161225 %>% select(patient, ndosbm_diag, posmye_juillet2025_5), "./output/161225.xlsx")


all_variants_data_161225 <- process_xml_folder("./input/bm/XML/161225_XML_BASE/patient")

(
  all_variants_data_161225
  %>% mutate(ndosbm = str_remove(xml_file_name, "D[0-9]{2}.xml"))
  %>% filter(prefered_transcript == "YES")
  %>% select(dossier = main_sample_name, ndosbm, lib, nucleotidic_position, proteinic_position, chromosome, position, reference, alternative, transcript, exon)
  %>% distinct()
  %>% ungroup()
) -> variant_data161225

(
  read_xlsx("./output/161225.xlsx")
  %>% filter(!is.na(CHECK))
) -> done

length(unique(done$ndosbm_diag)) # 17

(
  read_xlsx("./output/161225.xlsx")
  %>% filter(is.na(CHECK))
  %>% separate_rows(posmye_juillet2025_5, sep = "\\\\br\\.|\\r?\\n")
  %>% mutate(posmye_juillet2025_5 = str_remove(posmye_juillet2025_5, "\\\\"))
  %>% mutate(gene = str_extract(posmye_juillet2025_5, list_gene_LOVER_2023))
  %>% mutate(vaf = str_extract(posmye_juillet2025_5, "\\d+(\\.\\d+)?%")) 
  %>% mutate(vaf = as.numeric(str_remove(vaf, "%")))
  %>% mutate(c. = str_extract(posmye_juillet2025_5, "c.* :"))
  %>% mutate(c. = ifelse(is.na(c.), str_extract(posmye_juillet2025_5, "c.* \\("),c.))
  %>% mutate(c. = str_remove(c., "( :)| \\("))
  %>% mutate(p. = str_extract(posmye_juillet2025_5, "p\\..*\\("))
  %>% mutate(p. = str_remove(p., "\\("))
  %>% mutate(p. = ifelse(is.na(p.), "p.intron", p.))
  %>% mutate(mutation = paste0(gene, "_", p.))
  %>% left_join(variant_data161225, by=c("ndosbm_diag" = "ndosbm", "c." = "nucleotidic_position"))
  %>% mutate(
    chromosome = case_when(
      str_detect(c., "c.868_870delinsCGGTTCC") ~ "chr5",
      TRUE ~ chromosome
    ),
    position = case_when(
      str_detect(c., "c.868_870delinsCGGTTCC") ~ "170837554",
      TRUE ~ position
    ),
    reference = case_when(
      str_detect(c., "c.868_870delinsCGGTTCC") ~ "G",
      TRUE ~ reference
    ),
    alternative = case_when(
      str_detect(c., "c.868_870delinsCGGTTCC") ~ "GTTCC",
      TRUE ~ alternative
    ),
    exon = case_when(
      str_detect(c., "c.868_870delinsCGGTTCC") ~ "11",
      TRUE ~ exon
    )
  )
  %>% mutate(
    chromosome = case_when(
      str_detect(c., "c.1804_1805ins51") ~ "chr13",
      TRUE ~ chromosome
    ),
    position = case_when(
      str_detect(c., "c.1804_1805ins51") ~ "28608251",
      TRUE ~ position
    ),
    reference = case_when(
      str_detect(c., "c.1804_1805ins51") ~ "T",
      TRUE ~ reference
    ),
    alternative = case_when(
      str_detect(c., "c.1804_1805ins51") ~ "TTGAGATCATATTCATATTCTCTGAAATCAACGTAGAAGTACTCATTATTGG",
      TRUE ~ alternative
    ),
    exon = case_when(
      str_detect(c., "c.1804_1805ins51") ~ "14",
      TRUE ~ exon
    )
  )
) -> all # 76 = 93

(
  all
  # %>% filter(is.na(dossier))
  %>% filter(posmye_juillet2025_5 == "Analyse n√©gative")
  %>% mutate(
    dossier = case_when(
      str_detect(ndosbm_diag, "L2013684") ~ "L2013684D01",
      TRUE ~ dossier
    ),
    lib = case_when(
      str_detect(ndosbm_diag, "L2013684") ~ "TW-MYELOV-260121",
      TRUE ~ ndosbm_diag
  ))
  %>% mutate(
    dossier = case_when(
      str_detect(ndosbm_diag, "L2013806") ~ "L2013806D01",
      TRUE ~ dossier
    ),
    lib = case_when(
      str_detect(ndosbm_diag, "L2013806") ~ "TW-LOVER-HEMATO-141022",
      TRUE ~ lib
  ))
  %>% mutate(
    dossier = case_when(
      str_detect(ndosbm_diag, "L2009832") ~ "L2009832D01",
      TRUE ~ dossier
    ),
    lib = case_when(
      str_detect(ndosbm_diag, "L2009832") ~ "TW-MYELOV-140121",
      TRUE ~ lib
  ))
  %>% mutate(
    dossier = case_when(
      str_detect(ndosbm_diag, "L2100515") ~ "L2100515D01",
      TRUE ~ dossier
    ),
    lib = case_when(
      str_detect(ndosbm_diag, "L2100515") ~ "TW-MYELOV-260121",
      TRUE ~ lib
  ))
  %>% select(-c., -p.)
) -> all_neg

neg_import <- unique(all_neg[, c("dossier")])
neg_import$source_file <- paste0(neg_import$dossier, "_MANUAL.XLSX")

write.table(
  neg_import["source_file"],
  file = "./output/161225_all_neg_import_log.tsv",
  sep = "\t",
  row.names = FALSE,
  col.names = TRUE,
  quote = FALSE
)

(
  all
  %>% filter(!is.na(dossier))
  %>% select(ndosbm_diag, dossier, lib, gene, chromosome, position, reference, alternative, transcript, exon, nucleotidic_position = c., proteinic_position, var_freq = vaf)
  %>% ungroup()
  %>% group_by(ndosbm_diag)
  %>% fill(dossier, lib, .direction = "updown")
  %>% ungroup()
  %>% select(-ndosbm_diag)
  # %>% filter(is.na(gene))
) -> all_pos

all_pos$source_file <- paste0(all_pos$dossier, "_MANUAL.XLSX")

write.table(
  all_pos,
  file = "./output/161225_all_pos_variants.tsv",
  sep = "\t",
  row.names = FALSE,
  quote = FALSE,
  na = ""
)

length(unique(all_pos$ndosbm_diag))

pos_import <- unique(all_pos[, c("dossier")])
pos_import$source_file <- paste0(pos_import$dossier, "_MANUAL.XLSX")

write.table(
  pos_import["source_file"],
  file = "./output/all_pos_import_log.tsv",
  sep = "\t",
  row.names = FALSE,
  col.names = TRUE,
  quote = FALSE
)

# - TNGE -15G-008 -15G-012 = 93

(
  read_tsv("./input/bm/path_161225.tsv")
  %>% clean_names()
  %>% filter(!str_detect(path, "RES_L"))
  %>% filter(!str_detect(path, ".xlsx"))
  %>% mutate(folder = str_extract(path, "(patient)|(GROUP-100000)|(GROUP-100)"))
  %>% filter(!(id == "L2009850" & is.na(folder)))
  %>% filter(!(id == "L2009824" & is.na(folder)))
  %>% filter(!(id == "L2009845" & is.na(folder)))
  %>% filter(!(id == "L2009822" & is.na(folder)))
  %>% filter(!(id == "L2009832" & is.na(folder)))
  %>% filter(!(id == "L2012679" & is.na(folder)))
  %>% filter(!(id == "L2012675" & is.na(folder)))
  %>% group_by(id, folder)
  %>% slice_max(date)
  %>% group_by(id)
  %>% mutate(n = n())
  # %>% ungroup()
  # %>% filter(folder == "GROUP-100000")
  # %>% select(path)
  # %>% write_tsv(., pipe("pbcopy"))
  # %>% ungroup()
  # %>% distinct(id)
) -> path_161225
```

# 090126

* 96 patients

  * 2 patients MDS-ALLO-RISK, en aveugle
  * 8 patients (cacouille - Virginie), √©galement en aveugle
  * 1 TNEG

* 85 patients analysables

  * 12 BIG

    * 11 Toulouse (mort pour la France)
    * 1 Strasbourg (OK)

  * 73 autres

    * 70 OK
    * 1 mauvais : ndsobm ADN381-63_DG
    * 2 √ò ndsobm_diag / √ò POSMYE

* Au total : 71 patients avec ndosbm dispo

  * 4 diag Analyse n√©gative
  * 18 Aucun r√©sultat (apr√®s filtre regex des path)

* Au total 49 ...

```{r}

(
  read_xls("./input/bm/TW-MRD-090126-DRAGEN.xls")
  %>% clean_names()
  # %>% count(patient)
  # %>% filter(n > 1)
  %>% filter(str_detect(patient, "BIG"))
  %>% mutate(patient = str_to_upper(patient))
  %>% mutate(patient = str_replace_all(patient, " ", "_"))
  %>% mutate(patient = str_replace_all(patient, "PHILIPPE_DOMINIQUE", "PHILIPPE"))
  %>% mutate(patient = str_replace_all(patient, "TAYSSE,FRANCOISE", "TAYSSE ,FRAN√áOISE"))
  %>% mutate(patient = str_replace_all(patient, "CHAIT,NAIMA", "CHAIT,NAIMA_(KHANZA)"))
  %>% filter(prelevement != "T-NEG-090126")
  %>% mutate(n_bm = str_remove(prelevement, "D[0-9]{2}"))
  %>% left_join(ALL_POSMYE, by = c("patient" = "nom"))
  %>% filter(str_detect(ndosbm_diag, "L"))
  # %>% filter()
  # %>% select(ndosbm_diag)
  # %>% write_tsv(., pipe("pbcopy"))
) -> RUN_090126_BIG

(
  read_xls("./input/bm/TW-MRD-090126-DRAGEN.xls")
  %>% clean_names()
  # %>% count(patient)
  # %>% filter(n > 1)
  %>% filter(!str_detect(patient, "BIG"))
  %>% mutate(patient = str_to_upper(patient))
  %>% mutate(patient = str_replace_all(patient, " ", "_"))
  %>% mutate(patient = str_replace_all(patient, "PHILIPPE_DOMINIQUE", "PHILIPPE"))
  %>% mutate(patient = str_replace_all(patient, "TAYSSE,FRANCOISE", "TAYSSE ,FRAN√áOISE"))
  %>% mutate(patient = str_replace_all(patient, "CHAIT,NAIMA", "CHAIT,NAIMA_(KHANZA)"))
  %>% filter(prelevement != "T-NEG-090126")
  %>% mutate(n_bm = str_remove(prelevement, "D[0-9]{2}"))
  %>% left_join(ALL_POSMYE, by = c("patient" = "nom"))
  %>% filter(projet != "MRD_LAM")
  %>% filter(!is.na(id))
  %>% bind_rows(RUN_090126_BIG)
  %>% filter(!str_detect(ndosbm_diag, fixed(".")))
  # %>% filter()
  # %>% select(ndosbm_diag)
  # %>% write_tsv(., pipe("pbcopy"))
) -> RUN_090126_NOBIG

(
  read_tsv("./input/bm/path090126.tsv")
  %>% clean_names()
  %>% filter(!str_detect(path, "GROUP-100"))
  %>% filter(!str_detect(path, "Q100"))
  %>% filter(!str_detect(path, "GROUP-100000"))
  # %>% distinct(id)
  # %>% nrow()
  %>% filter(!str_detect(path, "FILT3R"))
  %>% group_by(id)
  %>% slice_max(date)
  %>% ungroup()
  %>% select(path)
  # %>% count(id)
) -> path

write_tsv(path, "./output/path090126.tsv", col_names = FALSE)

(
  process_xml_folder_parallel("./input/bm/XML/090126/")
) -> all_variants_data_090126

(
  all_variants_data_090126
  %>% mutate(ndsobm = str_extract(main_sample_name, "L[0-9]{7}"))
) -> all_variants_data_090126_clean

(
  RUN_090126_NOBIG
  %>% separate_rows(posmye_juillet2025_5, sep = "\\\\br\\.|\\r?\\n")
  %>% mutate(posmye_juillet2025_5 = str_remove(posmye_juillet2025_5, "\\\\"))
  %>% mutate(gene = str_extract(posmye_juillet2025_5, list_gene_LOVER_2023))
  %>% mutate(vaf = str_extract(posmye_juillet2025_5, "\\d+(\\.\\d+)?%")) 
  %>% mutate(vaf = as.numeric(str_remove(vaf, "%")))
  %>% mutate(c. = str_extract(posmye_juillet2025_5, "c.* :"))
  %>% mutate(c. = ifelse(is.na(c.), str_extract(posmye_juillet2025_5, "c.* \\("),c.))
  %>% mutate(c. = str_remove(c., "( :)| \\("))
  %>% mutate(p. = str_extract(posmye_juillet2025_5, "p\\..*\\("))
  %>% mutate(p. = str_remove(p., "\\("))
  %>% mutate(p. = ifelse(is.na(p.), "p.intron", p.))
  %>% mutate(mutation = paste0(gene, "_", p.))
  %>% left_join(all_variants_data_090126_clean, by=c("ndosbm_diag" = "ndosbm", "c." = "nucleotidic_position"))
) -> all

```